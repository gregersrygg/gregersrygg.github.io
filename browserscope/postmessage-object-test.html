<!DOCTYPE html>
<html>
<head>
    <title>Test if postMessage can only send strings or </title>
</head>
<body>
<p>postMessage can send messages between frames, windows and web workers. This page tests what your browser is capable of sending with postMessage.</p>

<script>
var _bTestResults = {};

(function (win, doc) {
    var asyncTests;
    var iframeWin;
    win.setIframeWin = function (win) {
        iframeWin = win;
        runTests();
    };

    var async = {
        'send_object': function (done) {
            listenOnce(function (message) {
                done(typeof message == 'object');
            });
            iframeWin.top.postMessage({foo: 'bar'}, '*');
        },
        'send_number': function (done) {
            listenOnce(function (message) {
                done(message === 5);
            });
            iframeWin.top.postMessage(5, '*');
        },
        'send_date': function (done) {
            var date = new Date();
            listenOnce(function (message) {
                done(message instanceof Date && 
                    date.getTime() == message.getTime());
            });
            iframeWin.top.postMessage(date, '*');
        },
        'send_blob': function (done) {
            var supportsBlob = false, blob;
            try {
              supportsBlob = !!new Blob();
            } catch (e) {}

            if (supportsBlob) {
                blob = new Blob(['blob test'], {type : 'text/plain'});
                listenOnce(function (message) {
                    done(message instanceof Blob &&
                        message.type == 'text/plain' && message.size == blob.size);
                });
                iframeWin.top.postMessage(blob, '*');
            } else {
                done(false);
            }
        }
    };

    function createIframe () {
        var iframeContent = '<!DOCTYPE html><scr'+'ipt>parent.setIframeWin(this);</scr'+'ipt>';
        var iframe = doc.createElement('iframe');
        iframe.style.border = iframe.style.width = iframe.style.height = 0;
        doc.body.appendChild(iframe);
        var iDoc = iframe.contentWindow.document;
        iDoc.open('text/html', 'replace');
        iDoc.write(iframeContent);
        iDoc.close();
    }

    function listenOnce (fn) {
        function callback (evt) {
            if (win.removeEventListener) {
                removeEventListener('message', callback ,false);
            } else if (win.detachEvent) {
                detachEvent('onmessage', callback);
            }
            fn(evt.data);
        }
        if (win.addEventListener) {
            addEventListener('message', callback, false);
        } else if (win.attachEvent) {
            attachEvent('onmessage', callback);
        }
    }

    function runTests () {
        _bTestResults.only_strings = onlyStrings();
        asyncTests = Object.keys(async);
        runNext();
    }

    function runNext () {
        if (asyncTests.length > 0) {
            var next = asyncTests.shift();
            var test = async[next];
            var didThrow = false;
            var onComplete = function (result) {
                _bTestResults[next] = result;
                _bTestResults[next + "_threw_error"] = didThrow;
                runNext();
            };
            try {
                test(onComplete);
            } catch (e) {
                didThrow = true;
                onComplete(false);
            }
        } else {
            postResults();
        }

    }

    function onlyStrings () {
        var onlyStrings = false;
        try {
            win.postMessage({
                toString: function () {
                    onlyStrings = true;
                }
            }, "*");
        } catch (e) {}

        return onlyStrings;
    }

    function postResults () {
        console.log(_bTestResults);
        // Beacon the results to Browserscope.
        /*var testKey = 'CHANGE-THIS-TO-YOUR-TEST-KEY';
        var script = doc.createElement('script'),
        script.src = 'http://www.browserscope.org/user/beacon/' + testKey;
        doc.body.appendChild(script);*/
    }

    createIframe();

})(window, document);
</script>
</body>
</html>