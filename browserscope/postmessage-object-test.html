<!DOCTYPE html>
<html>
<head>
    <title>Test what postMessage can send as message</title>
</head>
<body>
<h1>Test what postMessage can send as message</h1>
<p>postMessage can send messages between frames, windows and web workers. This page tests what your browser is capable of sending with postMessage.</p>

<script src="http://www.browserscope.org/ua?o=js"></script>

<script>
var _bTestResults = {};

function postResults () {
    var val;
    for (var key in _bTestResults) {
        val = _bTestResults[key];
        if (typeof val == 'boolean') {
            _bTestResults[key] = (val ? 1 : 0);
        }
    }
    if (window.console) { console.log(_bTestResults); }
    // Beacon the results to Browserscope.
    var testKey = 'agt1YS1wcm9maWxlcnIRCxIEVGVzdBiAgIDE7qGDCQw';
    var script = document.createElement('script');
    script.src = 'http://www.browserscope.org/user/beacon/' + testKey;
    document.body.appendChild(script);
}

window.onerror = function (message, url, line) {
    _bTestResults.error = ['ERROR ', 'line:', line, ' ', message].join('');
    postResults();
};

var runTests = (function (win, doc) {
    var testQueue;
    var iframeWin;
    var lastAddedListener;
    var supportsPostMessage = 'postMessage' in window;
    win.setIframeWin = function (win) {
        iframeWin = win;
        runTests();
    };

    var allTests = {
        'only_strings': function (done) {
            var onlyStrings = false;
            try {
                win.postMessage({
                    toString: function () {
                        onlyStrings = true;
                    }
                }, '*');
            } catch (e) {}

            done(onlyStrings);
        },

        'send_object': function (done) {
            listenOnce(function (message) {
                done(typeof message == 'object');
            });
            iframeWin.top.postMessage({foo: 'bar'}, '*');
        },

        'send_number': function (done) {
            listenOnce(function (message) {
                done(message === 5);
            });
            iframeWin.top.postMessage(5, '*');
        },

        'send_date': function (done) {
            var date = new Date();
            listenOnce(function (message) {
                done(message instanceof Date && 
                    date.getTime() == message.getTime());
            });
            iframeWin.top.postMessage(date, '*');
        },

        'send_array': function (done) {
            listenOnce(function (message) {
                done(message.length === 3 && message[2] === 3);
            });
            iframeWin.top.postMessage([1, 2, 3], '*');
        },

        'send_deep_object': function (done) {
            var bar = {'a': 'b'};
            listenOnce(function (message) {
                done(typeof message == 'object' &&
                    typeof message.foo == 'object' && message.foo.a === 'b');
            });
            iframeWin.top.postMessage({foo: bar}, '*');
        },

        'send_nested_array': function (done) {
            var arr = [1, 2, 3];
            listenOnce(function (message) {
                done(message.length === 1 && message[0].length === 3 &&
                    message[0][2] === 3);
            });
            iframeWin.top.postMessage([arr], '*');
        },

        'send_blob': function (done) {
            var supportsBlob = false, blob;
            try {
              supportsBlob = !!new Blob();
            } catch (e) {}

            _bTestResults.supports_blob = supportsBlob;
            if (supportsBlob) {
                blob = new Blob(['blob test'], {type : 'text/plain'});
                listenOnce(function (message) {
                    done(message instanceof Blob &&
                        message.type == 'text/plain' && message.size == blob.size);
                });
                iframeWin.top.postMessage(blob, '*');
            } else {
                done(false);
            }
        },

        'send_arraybuffer': function (done) {
            var supportsArrayBuffer = true;
            var buf;
            try {
                buf = new ArrayBuffer(16);
            } catch (e) {
                supportsArrayBuffer = false;
            }
            _bTestResults.supports_arraybuffer = supportsArrayBuffer;
            if (supportsArrayBuffer) {
                listenOnce(function (message) {
                    done(message && message.byteLength === 16);
                });
                iframeWin.top.postMessage(buf, '*');
            } else {
                done(false);
            }
        },

        'send_pixel_data': function (done) {
            var canvas = doc.createElement('canvas');
            var supportsCanvas = !!(canvas.getContext && canvas.getContext('2d'));
            _bTestResults.supports_canvas = supportsCanvas;
            if (supportsCanvas) {
                canvas.style.width = canvas.style.height = '10px';
                var ctx = canvas.getContext('2d');
                var imageData = ctx.getImageData(0, 0, 10, 10);
                if (imageData) {
                    listenOnce(function (message) {
                        done(message && message.length > 0);
                    });
                    iframeWin.top.postMessage(imageData.data, '*');
                } else {
                    _bTestResults.no_canvas_pixel_data = true;
                }
            } else {
                done(false);
            }
        },

        'send_filelist': function (done) {
            var supportsFileList = !!(win.FileList);
            var f, files;
            _bTestResults.supports_filelist = supportsFileList;
            if (supportsFileList) {
                f = document.createElement('input');
                f.type = 'file';
                f.multiple = true;
                listenOnce(function (message) {
                    done(message instanceof FileList && message.length === 0);
                });
                iframeWin.top.postMessage(f.files, '*');
            } else {
                done(false);
            }

        }
    };

    function createIframe () {
        var iframeContent = '<!DOCTYPE html><scr'+'ipt>parent.setIframeWin(this);</scr'+'ipt>';
        var iframe = doc.createElement('iframe');
        iframe.style.border = iframe.style.width = iframe.style.height = 0;
        doc.body.appendChild(iframe);
        var iDoc = iframe.contentWindow.document;
        iDoc.open('text/html', 'replace');
        iDoc.write(iframeContent);
        iDoc.close();
    }

    function removeListener (fn) {
        if (win.removeEventListener) {
            removeEventListener('message', fn ,false);
        } else if (win.detachEvent) {
            detachEvent('onmessage', fn);
        }
    }
    function listenOnce (fn) {
        function callback (evt) {
            removeListener(callback);
            fn(evt.data);
        }
        if (win.addEventListener) {
            addEventListener('message', callback, false);
        } else if (win.attachEvent) {
            attachEvent('onmessage', callback);
        }
        lastAddedListener = callback;
    }

    function runTests () {
        testQueue = [];
        for (var key in allTests) {
            testQueue.push(key);
        }
        runNext();
    }

    function runNext () {
        if (testQueue.length > 0) {
            var next = testQueue.shift();
            var test = allTests[next];
            lastAddedListener = null;
            var onComplete = function (result) {
                _bTestResults[next] = result;
                runNext();
            };
            try {
                test(onComplete);
            } catch (e) {
                _bTestResults[next + '_threw_error'] = e.message;
                if (lastAddedListener) {
                    removeListener(lastAddedListener);
                }
                onComplete(false);
            }
        } else {
            postResults();
        }

    }

    _bTestResults.supports_postmessage = supportsPostMessage;
    
    return function () {
        if (supportsPostMessage) {
            createIframe();
        } else {
            for (var key in allTests) {
                _bTestResults[key] = false;
            }
        }
    };

})(window, document);
</script>

<script src="http://www.browserscope.org/user/tests/button?fn=runTests&btn_text=Run%20the%20test"></script>
</body>
</html>